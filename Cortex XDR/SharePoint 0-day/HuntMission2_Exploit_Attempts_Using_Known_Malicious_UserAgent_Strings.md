# Detection of Exploit Attempts Using Known Malicious User-Agent Strings

## Severity or Impact of the Detected Behavior
- **Risk Score:** 80
- **Severity:** High

## Hunt Analytics Metadata

- **ID:** HuntQuery-SharePoint-MaliciousUserAgent
- **Operating Systems:** WindowsServer, SharePoint
- **False Positive Rate:** Low

---

## Hunt Analytics

This hunt detects exploit attempts against Microsoft SharePoint by identifying HTTP requests to SharePoint LAYOUTS paths (`/_layouts/15/` or `/_layouts/16/`) that use a specific Firefox User-Agent string known to be associated with recent exploitation campaigns. Attackers often use unique or rarely seen User-Agent strings to evade detection or mimic legitimate traffic while exploiting vulnerabilities in public-facing applications.

Detected behaviors include:

- HTTP requests to SharePoint LAYOUTS endpoints
- User-Agent string: `Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:120.0) Gecko/20100101 Firefox/120.0` (or its URL-encoded variant)

These patterns are indicative of automated exploitation tools or scripts leveraging known User-Agent signatures.

---

## ATT&CK Mapping

| Tactic                        | Technique   | Subtechnique | Technique Name                                 |
|------------------------------|-------------|--------------|-----------------------------------------------|
| TA0001 - Initial Access       | T1190       | —            | Exploit Public-Facing Application             |
| TA0011 - Command and Control | T1071.001   | —            | Application Layer Protocol: Web Protocols      |

---

## Hunt Query Logic

This query identifies exploit attempts by looking for:

- Network events with requests to SharePoint LAYOUTS paths
- HTTP User-Agent string matching the known malicious Firefox signature (plain or URL-encoded)

These patterns are indicative of attempts to exploit SharePoint using automated tools or scripts with known User-Agent strings.

---

## Hunt Query Syntax

**Query Language:** XQL (Cortex Query Language)  
**Platform:** Polo Alto Networks Cortex XDR and XSIAM

```xql
// Title: Detection of Exploit Attempts Using Known Malicious User-Agent Strings
// Description: Detects HTTP requests to SharePoint LAYOUTS paths using a specific Firefox User-Agent string observed in exploitation waves.
// MITRE ATT&CK TTP IDs: T1190, T1071.001

dataset = xdr_data   
| filter event_type = ENUM.NETWORK  
| filter dst_action_url contains "/_layouts/15/" or dst_action_url contains "/_layouts/16/"    
| filter action_user_agent = "Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:120.0) Gecko/20100101 Firefox/120.0" or action_user_agent = "Mozilla/5.0+(Windows+NT+10.0;+Win64;+x64;+rv:120.0)+Gecko/20100101+Firefox/120.0"   
| fields event_timestamp, agent_hostname , dst_action_url, http_method, http_referer, action_user_agent  
```

---

## Data Sources

| Log Provider   | Event Name   | ATT&CK Data Source | ATT&CK Data Component |
|---------------|--------------|--------------------|-----------------------|
| Cortex XSIAM  | xdr_data     | Network Traffic    | Web Request           |

---

## Execution Requirements

- **Required Permissions:** Ability to collect and analyze network traffic logs from SharePoint servers.
- **Required Artifacts:** Network event logs, HTTP request metadata (method, URL, referer, user agent).

---

## Considerations

- Review the source IP and frequency of requests using the suspicious User-Agent string.
- Correlate with other indicators of compromise, such as unusual authentication attempts or exploitation patterns.
- Investigate any follow-on activity from the same source, such as privilege escalation or lateral movement.
- Validate if the SharePoint instance is patched for known vulnerabilities.

---

## False Positives

False positives are unlikely but may occur if:

- Legitimate automated tools or scripts use the same User-Agent string for testing or monitoring.
- Security scanners or vulnerability assessment tools mimic known User-Agent strings.

---

## Recommended Response Actions

1. Investigate the source and intent of the HTTP request.
2. Review SharePoint server logs for signs of exploitation or unauthorized changes.
3. Isolate affected servers if compromise is suspected.
4. Apply security patches for any relevant SharePoint vulnerabilities.
5. Monitor for additional suspicious activity from the same source.

---

## References

- [MITRE ATT&CK: T1190 – Exploit Public-Facing Application](https://attack.mitre.org/techniques/T1190/)
- [MITRE ATT&CK: T1071.001 – Application Layer Protocol: Web Protocols](https://attack.mitre.org/techniques/T1071/001/)
- [Microsoft Security Blog: Disrupting Active Exploitation of On-Premises SharePoint Vulnerabilities (July 22, 2025)](https://www.microsoft.com/en-us/security/blog/2025/07/22/disrupting-active-exploitation-of-on-premises-sharepoint-vulnerabilities/)
- [Unit 42: Microsoft SharePoint CVE-2025-49704, CVE-2025-49706, CVE-2025-53770 Analysis](https://unit42.paloaltonetworks.com/microsoft-sharepoint-cve-2025-49704-cve-2025-49706-cve-2025-53770/)
- [Eye Security: SharePoint Under Siege](https://research.eye.security/sharepoint-under-siege/)

---

## Version History

| Version | Date       | Impact            | Notes                                                                                      |
|---------|------------|-------------------|--------------------------------------------------------------------------------------------|
| 1.0     | 2025-07-21 | Initial Detection | Created hunt query to detect exploit attempts using known malicious User-Agent strings |
