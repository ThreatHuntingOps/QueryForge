# Detection of ToolPane.aspx Exploitation via DotNet Telemetry

## Severity or Impact of the Detected Behavior
- **Risk Score:** 90
- **Severity:** Critical

## Hunt Analytics Metadata

- **ID:** HuntQuery-SharePoint-ToolPane-DotNetTelemetry
- **Operating Systems:** WindowsServer, SharePoint
- **False Positive Rate:** Low

---

## Hunt Analytics

This hunt leverages .NET telemetry to identify exploitation attempts against SharePoint ToolPane.aspx by detecting references to ToolPane.aspx in the IIS worker process (`w3wp.exe`). The query extracts rich context from process command lines and dynamic event maps, including IIS application pool names, source IPs, request URIs, decoded payloads, and HTTP headers. This approach provides deep visibility into exploitation attempts and post-exploitation activity, especially for environments running agent version 8.7 or higher.

Detected behaviors include:

- .NET events from `w3wp.exe` referencing ToolPane.aspx
- Extraction of IIS application pool name, source IP, request URI, decoded payload, and HTTP headers
- Identification of X-Forwarded-For headers to trace the true source of exploitation

These patterns are indicative of advanced exploitation and post-exploitation activity targeting SharePoint servers.

---

## ATT&CK Mapping

| Tactic                        | Technique   | Subtechnique | Technique Name                                 |
|------------------------------|-------------|--------------|-----------------------------------------------|
| TA0001 - Initial Access       | T1190       | —            | Exploit Public-Facing Application             |
| TA0002 - Execution           | T1059       | —            | Command and Scripting Interpreter             |
| TA0008 - Persistence         | T1505.003   | —            | Server Software Component: Web Shell           |

---

## Hunt Query Logic

This query identifies exploitation attempts by looking for:

- .NET events from `w3wp.exe` with thread context referencing ToolPane.aspx
- Extraction of IIS application pool name from process command line
- Extraction of source IP, request URI, decoded payload, and HTTP headers from dynamic event map
- Parsing of X-Forwarded-For headers to identify the true source IP

These patterns are indicative of exploitation and post-exploitation activity in SharePoint environments.

---

## Hunt Query Syntax

**Query Language:** XQL (Cortex Query Language)  
**Platform:** Palo Alto Cortex XSIAM

```xql
// Note: This query will only work on agents 8.7 or higher
// Description: This query leverages DotNet telemetry to identify references to ToolPane.exe, and extracts fields to provide additional context.
dataset = xdr_data
| fields _time, agent_hostname, actor_effective_username, actor_process_image_name, actor_process_image_path, actor_process_command_line, dynamic_event_string_map, event_thread_context, event_type
| filter event_type = ENUM.DOT_NET and actor_process_image_name = "w3wp.exe" and event_thread_context contains "ToolPane.aspx"

// Extract the IIS application pool name from command line
| alter IIS_appName = arrayindex(regextract(actor_process_command_line, "\-ap\s+\"([^\"]+)\""), 0)

// Extract fields from the dynamic_string_string_map:
// EventSrcIP - Logged IP address by the IIS server
// RequestURI - The requested URL by the threat actor
// Payload - time he decoded .NET payload from exploitation
// Headers - HTTP request headers
| alter EventSrcIP = trim(json_extract(dynamic_event_string_map, "$.27"), "\""),
        RequestURI = trim(json_extract(dynamic_event_string_map, "$.26"), "\""),
        Payload = trim(json_extract(dynamic_event_string_map, "$.30"), "\""),
        Headers = trim(json_extract(dynamic_event_string_map, "$.32"), "\"")

// Extract the X-Forwarded-For headers from the Headers field in an attempt to identify the source of exploitation
| alter x_forwarded_for_header = regextract(lowercase(Headers), "\|(?:client-ip|x-forwarded-for)\:((?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[1-9])(?:\.(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])){3})\|")

| fields _time, agent_hostname, actor_effective_username, actor_process_image_path, actor_process_command_line, IIS_appName, dynamic_event_string_map, event_thread_context, EventSrcIP, x_forwarded_for_header, RequestURI, Payload, Headers
```

---

## Data Sources

| Log Provider   | Event Name   | ATT&CK Data Source | ATT&CK Data Component |
|---------------|--------------|--------------------|-----------------------|
| Cortex XSIAM  | xdr_data     | Application Log    | .NET Telemetry        |

---

## Execution Requirements

- **Required Permissions:** Ability to collect and analyze .NET telemetry and process logs from SharePoint servers (agent 8.7+ required).
- **Required Artifacts:** .NET event logs, process command lines, dynamic event maps, HTTP headers.

---

## Considerations

- Review the decoded payload and HTTP headers for evidence of exploitation or malicious activity.
- Correlate with network, file, and authentication logs for signs of lateral movement or persistence.
- Investigate any follow-on activity from the same host or user account.
- Validate if the SharePoint instance is patched for known vulnerabilities.

---

## False Positives

False positives are unlikely but may occur if:

- Legitimate administrative or monitoring tools reference ToolPane.aspx in .NET events.
- Custom SharePoint solutions generate similar telemetry.

---

## Recommended Response Actions

1. Investigate the decoded payload and HTTP headers for evidence of exploitation.
2. Review the IIS application pool and process context for unauthorized activity.
3. Isolate affected servers if compromise is suspected.
4. Apply security patches for any relevant SharePoint vulnerabilities.
5. Monitor for additional suspicious activity or persistence mechanisms.

---

## References

- [MITRE ATT&CK: T1190 – Exploit Public-Facing Application](https://attack.mitre.org/techniques/T1190/)
- [MITRE ATT&CK: T1059 – Command and Scripting Interpreter](https://attack.mitre.org/techniques/T1059/)
- [MITRE ATT&CK: T1505.003 – Server Software Component: Web Shell](https://attack.mitre.org/techniques/T1505/003/)
- [Microsoft Security Blog: Disrupting Active Exploitation of On-Premises SharePoint Vulnerabilities (July 22, 2025)](https://www.microsoft.com/en-us/security/blog/2025/07/22/disrupting-active-exploitation-of-on-premises-sharepoint-vulnerabilities/)
- [Unit 42: Microsoft SharePoint CVE-2025-49704, CVE-2025-49706, CVE-2025-53770 Analysis](https://unit42.paloaltonetworks.com/microsoft-sharepoint-cve-2025-49704-cve-2025-49706-cve-2025-53770/)
- [Eye Security: SharePoint Under Siege](https://research.eye.security/sharepoint-under-siege/)

---

## Version History

| Version | Date       | Impact            | Notes                                                                                      |
|---------|------------|-------------------|--------------------------------------------------------------------------------------------|
| 1.0     | 2025-07-22 | Initial Detection | Created hunt query to detect ToolPane.aspx exploitation via DotNet telemetry |
