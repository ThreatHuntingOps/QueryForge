# Correlate Confluence Exploit Network Connection with whoami.exe Spawned by tomcat9.exe

## Severity or Impact of the Detected Behavior
- **Risk Score:** 85
- **Severity:** High

## Hunt Analytics Metadata

- **ID:** HuntQuery-CrowdStrike-ConfluenceWhoamiExploit
- **Operating Systems:** WindowsServer, LinuxServer
- **False Positive Rate:** Low

---

## Hunt Analytics

This hunt detects a sequence of behaviors indicative of active exploitation of Atlassian Confluence servers, specifically targeting CVE-2023-22527. The analytic correlates inbound network connections from known attacker IP addresses (e.g., 45.227.254.124, 91.191.209.46) with the subsequent spawning of the `whoami.exe` process by `tomcat9.exe`. This pattern is strongly associated with post-exploitation reconnaissance following successful remote code execution on vulnerable Confluence instances.

Detected behaviors include:

- Network connections from IPs linked to active exploitation campaigns
- Execution of `whoami.exe` (a common attacker reconnaissance command)
- Parent process of `whoami.exe` is `tomcat9.exe`, indicating exploitation via the Confluence application stack

Such activity is a strong indicator of successful exploitation and initial attacker foothold, often preceding further lateral movement or ransomware deployment.

---

## ATT&CK Mapping

| Tactic                        | Technique   | Subtechnique | Technique Name                                 |
|------------------------------|-------------|--------------|-----------------------------------------------|
| TA0001 - Initial Access       | T1190       | —            | Exploit Public-Facing Application             |
| TA0002 - Execution           | T1059       | 003          | Command and Scripting Interpreter: Windows Command Shell |
| TA0007 - Discovery           | T1033       | —            | System Owner/User Discovery                   |
| TA0008 - Lateral Movement    | T1021       | 001          | Remote Services: Remote Desktop Protocol      |

---

## Hunt Query Logic

This query identifies when a network connection from a known attacker IP is closely followed by the creation of a `whoami.exe` process with `tomcat9.exe` as its parent. This sequence is a strong indicator of exploitation of Confluence servers via CVE-2023-22527.

---

## Hunt Query Syntax

**Query Language:** CrowdStrike Query Language (CQL)  
**Platform:** CrowdStrike Falcon

```fql
// Outer query: network connection from attacker IP    
#event_simpleName=NetworkConnectIP4    
| RemoteAddress="45.227.254.124" or RemoteAddress="91.191.209.46"    
| join(    
  {    
    // Inner query: whoami.exe spawned by tomcat9.exe    
    #event_simpleName=ProcessRollup2    
    | FileName="whoami.exe"    
    | ParentBaseFileName="tomcat9.exe"    
  }    
  , field=TargetProcessId // NetworkConnectIP4's TargetProcessId    
  , key=ContextProcessId  // ProcessRollup2's ContextProcessId    
  , include=[FileName, ParentBaseFileName, CommandLine]    
)    
| groupBy([aid, ComputerName], limit=max, function=collect([RemoteAddress, FileName, ParentBaseFileName, CommandLine])) 
```

---

## Data Sources

| Log Provider | Event ID         | Event Name         | ATT&CK Data Source  | ATT&CK Data Component  |
|--------------|------------------|--------------------|---------------------|------------------------|
| Falcon       | N/A              | NetworkConnectIP4  | Network Connection  | Network Connection     |
| Falcon       | N/A              | ProcessRollup2     | Process             | Process Creation       |

---

## Execution Requirements

- **Required Permissions:** Attacker must be able to exploit a vulnerable Confluence server and execute code as the tomcat9 process.
- **Required Artifacts:** Network connection logs, process creation logs, attacker IP intelligence.

---

## Considerations

- Validate the context of the network connection and process creation to reduce false positives.
- Confirm that the parent process of `whoami.exe` is indeed `tomcat9.exe` and not a legitimate administrative action.
- Review additional process activity and network connections for signs of further exploitation or lateral movement.

---

## False Positives

False positives may occur if:

- Security or IT staff are performing legitimate diagnostics on Confluence servers from flagged IPs.
- Automated scripts or monitoring tools use similar process chains for health checks.

---

## Recommended Response Actions

1. Immediately isolate the affected Confluence server from the network.
2. Investigate the source and intent of the network connection from the attacker IP.
3. Review all processes spawned by `tomcat9.exe` for further malicious activity.
4. Hunt for additional indicators of compromise across the environment.
5. Patch vulnerable Confluence instances and review firewall rules to block known attacker IPs.

---

## References

- [DFIR Report: Another Confluence Bites the Dust – Falling to Elpaco Team Ransomware](https://thedfirreport.com/2025/05/19/another-confluence-bites-the-dust-falling-to-elpaco-team-ransomware/#case-summary)
- [MITRE ATT&CK: T1190 – Exploit Public-Facing Application](https://attack.mitre.org/techniques/T1190/)
- [MITRE ATT&CK: T1059.003 – Windows Command Shell](https://attack.mitre.org/techniques/T1059/003/)
- [MITRE ATT&CK: T1033 – System Owner/User Discovery](https://attack.mitre.org/techniques/T1033/)
- [MITRE ATT&CK: T1021.001 – Remote Desktop Protocol](https://attack.mitre.org/techniques/T1021/001/)

---

## Version History

| Version | Date       | Impact            | Notes                                                                                      |
|---------|------------|-------------------|--------------------------------------------------------------------------------------------|
| 1.0     | 2025-05-23 | Initial Detection | Created hunt query to detect Confluence exploit network connections and suspicious process spawning |
