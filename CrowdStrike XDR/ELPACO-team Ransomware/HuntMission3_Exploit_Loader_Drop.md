# Correlate Exploit Network Connection with Cobalt Strike/Metasploit Loader Drop

## Severity or Impact of the Detected Behavior
- **Risk Score:** 95
- **Severity:** Critical

## Hunt Analytics Metadata

- **ID:** HuntQuery-CrowdStrike-ExploitLoaderDrop
- **Operating Systems:** WindowsServer
- **False Positive Rate:** Very Low

---

## Hunt Analytics

This hunt detects a high-confidence sequence of behaviors associated with successful exploitation and payload delivery on Atlassian Confluence servers. It correlates inbound network connections from known attacker IP addresses (e.g., 45.227.254.124, 91.191.209.46) with the subsequent creation of a suspicious executable (e.g., HAHLGiDDb.exe) in the NetworkService temporary directory. This pattern is strongly associated with the delivery of Cobalt Strike or Metasploit loaders, which are commonly used for post-exploitation, command and control, and ransomware deployment.

Detected behaviors include:

- Network connections from IPs linked to active exploitation campaigns
- Creation of a suspicious executable in `C:\Windows\ServiceProfiles\NetworkService\AppData\Local\Temp\` (e.g., HAHLGiDDb.exe)

Such activity is a strong indicator of successful payload delivery and initial attacker foothold, often preceding further exploitation or lateral movement.

---

## ATT&CK Mapping

| Tactic                        | Technique   | Subtechnique | Technique Name                                 |
|------------------------------|-------------|--------------|-----------------------------------------------|
| TA0001 - Initial Access       | T1190       | —            | Exploit Public-Facing Application             |
| TA0002 - Execution           | T1059       | 003          | Command and Scripting Interpreter: Windows Command Shell |
| TA0004 - Privilege Escalation| T1055       | 001          | Process Injection: Dynamic-link Library Injection |
| TA0005 - Defense Evasion     | T1036       | 005          | Masquerading: Match Legitimate Name or Location |
| TA0008 - Lateral Movement    | T1021       | 001          | Remote Services: Remote Desktop Protocol      |

---

## Hunt Query Logic

This query identifies when a network connection from a known attacker IP is closely followed by the creation of a suspicious executable (e.g., HAHLGiDDb.exe) in the NetworkService temp directory. This sequence is a strong indicator of successful payload delivery, often associated with Cobalt Strike or Metasploit loader deployment.

---

## Hunt Query Syntax

**Query Language:** CrowdStrike Query Language (CQL)  
**Platform:** CrowdStrike Falcon

```fql
// Outer query: network connection from attacker IP    
#event_simpleName=NetworkConnectIP4    
| RemoteAddress="45.227.254.124" or RemoteAddress="91.191.209.46"    
| join(    
  {    
    // Inner query: suspicious executable creation in temp directory    
    #event_simpleName=FileCreate    
    | FileName="HAHLGiDDb.exe"    
    | FilePath=/C:\\Windows\\ServiceProfiles\\NetworkService\\AppData\\Local\\Temp\\HAHLGiDDb\.exe/i    
  }    
  , field=TargetProcessId // NetworkConnectIP4's TargetProcessId    
  , key=ContextProcessId  // FileCreate's ContextProcessId    
  , include=[FilePath, FileName]    
)    
| groupBy([aid, ComputerName], limit=max, function=collect([RemoteAddress, FilePath, FileName])) 
```

---

## Data Sources

| Log Provider | Event ID         | Event Name         | ATT&CK Data Source  | ATT&CK Data Component  |
|--------------|------------------|--------------------|---------------------|------------------------|
| Falcon       | N/A              | NetworkConnectIP4  | Network Connection  | Network Connection     |
| Falcon       | N/A              | FileCreate         | File                | File Creation          |

---

## Execution Requirements

- **Required Permissions:** Attacker must be able to exploit a vulnerable Confluence server and write files to the NetworkService temp directory.
- **Required Artifacts:** Network connection logs, file creation logs, attacker IP intelligence.

---

## Considerations

- Validate the context of the network connection and file creation to reduce false positives.
- Confirm that the file creation in the temp directory is not part of legitimate administrative or update activity.
- Review additional process and file activity for signs of further exploitation or lateral movement.

---

## False Positives

False positives may occur if:

- Security or IT staff are performing legitimate diagnostics on Confluence servers from flagged IPs.
- Automated scripts or monitoring tools create executables in the temp directory as part of normal operations.

---

## Recommended Response Actions

1. Immediately isolate the affected Confluence server from the network.
2. Investigate the source and intent of the network connection from the attacker IP.
3. Review all file creation events in the temp directory for further malicious activity.
4. Hunt for additional indicators of compromise across the environment.
5. Patch vulnerable Confluence instances and review firewall rules to block known attacker IPs.

---

## References

- [DFIR Report: Another Confluence Bites the Dust – Falling to Elpaco Team Ransomware](https://thedfirreport.com/2025/05/19/another-confluence-bites-the-dust-falling-to-elpaco-team-ransomware/#case-summary)
- [MITRE ATT&CK: T1190 – Exploit Public-Facing Application](https://attack.mitre.org/techniques/T1190/)
- [MITRE ATT&CK: T1059.003 – Windows Command Shell](https://attack.mitre.org/techniques/T1059/003/)
- [MITRE ATT&CK: T1055.001 – Process Injection: Dynamic-link Library Injection](https://attack.mitre.org/techniques/T1055/001/)
- [MITRE ATT&CK: T1036.005 – Masquerading: Match Legitimate Name or Location](https://attack.mitre.org/techniques/T1036/005/)

---

## Version History

| Version | Date       | Impact            | Notes                                                                                      |
|---------|------------|-------------------|--------------------------------------------------------------------------------------------|
| 1.0     | 2025-05-23 | Initial Detection | Created hunt query to detect exploit network connections and Cobalt Strike/Metasploit loader drops |
