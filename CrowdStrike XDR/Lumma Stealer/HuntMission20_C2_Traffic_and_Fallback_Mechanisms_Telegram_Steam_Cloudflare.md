# Detection of Lumma Stealer C2 Traffic and Fallback Mechanisms (Telegram, Steam, Cloudflare)

## Severity or Impact of the Detected Behavior
- **Risk Score:** 95
- **Severity:** High

## Hunt Analytics Metadata

- **ID:** HuntQuery-CrowdStrike-LummaStealer-C2-Traffic-Fallback
- **Operating Systems:** WindowsEndpoint, WindowsServer
- **False Positive Rate:** Medium

---

## Hunt Analytics

This hunt detects suspicious encrypted outbound connections that match Lumma Stealer’s C2 protocol patterns, including fallback mechanisms such as Telegram and Steam profiles, connections to Cloudflare-fronted infrastructure, and POST requests with parameters matching Lumma’s known C2 fields (e.g., `uid=`, `cid=`, `ver=4.0`, `lid=`, etc.). The query identifies network connections that:

- Use HTTP/HTTPS (ports 80/443) to known fallback infrastructure (`telegram.org`, `steamcommunity.com`, `cloudflare.com`, `cloudflare.net`)
- Issue POST requests with body parameters matching Lumma C2 markers (`ver=4.0`, `uid=`, `cid=`, `lid=`, `act=receive_message`, `act=send_message`, `act=get_message`)
- Are not generated by legitimate Telegram or Steam clients

These behaviors are highly indicative of Lumma Stealer C2 communication and fallback mechanisms.

---

## ATT&CK Mapping

| Tactic                        | Technique    | Subtechnique | Technique Name                                            |
|------------------------------|--------------|---------------|-----------------------------------------------------------|
| TA0011 - Command and Control  | T1071.001    | —             | Application Layer Protocol: Web Protocols (HTTPS)         |
| TA0011 - Command and Control  | T1090.002    | —             | Proxy: External Proxy (Cloudflare)                        |
| TA0011 - Command and Control  | T1090.003    | —             | Proxy: Multi-hop Proxy                                    |
| TA0011 - Command and Control  | T1102.002    | —             | Web Service: Bidirectional Communication (Telegram, Steam)|
| TA0010 - Exfiltration         | T1132.001    | —             | Data Encoding: Standard Encoding (Base64 / ChaCha20)      |

---

## Hunt Query Logic

This query identifies network connections that exhibit multiple Lumma Stealer C2 hallmarks:

- Outbound HTTP/HTTPS to Telegram, Steam, or Cloudflare infrastructure
- POST requests with body parameters matching Lumma C2 protocol
- Excludes legitimate Telegram and Steam client processes

These combined patterns are highly suggestive of Lumma Stealer C2 traffic and fallback mechanisms.

---

## Hunt Query Syntax

**Query Language:** CrowdStrike Query Language (CQL)  
**Platform:** CrowdStrike Falcon

```fql
#event_simpleName=NetworkConnection  
| (RemotePort = 443 OR RemotePort = 80)  
| in(field="RemoteAddress*", values=["*.telegram.org", "*.steamcommunity.com", "*.cloudflare.com", "*.cloudflare.net"]) 
| (HttpMethod = "POST" AND (HttpPostBody="ver=4.0" OR HttpPostBody="uid=" OR HttpPostBody="cid=" OR HttpPostBody="lid=" OR HttpPostBody="act=receive_message" OR HttpPostBody="act=send_message" OR HttpPostBody="act=get_message"))  
| NOT (FileName="telegram.exe" OR FileName="steam.exe") 
```

---

## Data Sources

| Log Provider | Event ID | Event Name       | ATT&CK Data Source  | ATT&CK Data Component  |
|--------------|----------|------------------|---------------------|------------------------|
| Falcon       | N/A      | NetworkConnection| Network             | Network Connection     |

---

## Execution Requirements

- **Required Permissions:** User or attacker must be able to initiate outbound network connections.
- **Required Artifacts:** Network connection logs, HTTP request/response bodies, process metadata.

---

## Considerations

- Review POST body content for additional C2 markers (e.g., `hwid`, `key`, `token`).
- Investigate User-Agent headers and SSL fingerprinting data for anomaly correlation.
- Correlate with process ancestry to identify non-browser or script-based clients.
- Monitor for repeated connections to fallback infrastructure.

---

## False Positives

False positives may occur if:

- Internal tools or scripts interact with Telegram, Steam, or Cloudflare APIs for legitimate purposes.
- Security testing or red team exercises simulate C2 traffic.

---

## Recommended Response Actions

1. Isolate the affected endpoint from the network.
2. Acquire network packet captures and endpoint logs for forensic analysis.
3. Investigate process ancestry and POST body content for evidence of compromise.
4. Search for additional indicators of Lumma Stealer or related malware.
5. Block identified malicious domains and IPs at the network perimeter.

---

## Notes for Analysts

- Lumma uses ChaCha20 and custom stack-based crypto for fallback infrastructure.
- All C2 traffic is sent via HTTPS POST, often toward Cloudflare, with identifying markers in body content.
- Look for clients beaconing to non-browser processes or scripts with suspicious POST bodies containing keywords like `uid`, `cid`, `hwid`, etc.
- If possible, extract User-Agent headers or SSL fingerprinting data from the sessions for anomaly correlation.

---

## References

- [MITRE ATT&CK: T1071.001 – Application Layer Protocol: Web Protocols](https://attack.mitre.org/techniques/T1071/001/)
- [MITRE ATT&CK: T1090.002 – Proxy: External Proxy](https://attack.mitre.org/techniques/T1090/002/)
- [MITRE ATT&CK: T1090.003 – Proxy: Multi-hop Proxy](https://attack.mitre.org/techniques/T1090/003/)
- [MITRE ATT&CK: T1102.002 – Web Service: Bidirectional Communication](https://attack.mitre.org/techniques/T1102/002/)
- [MITRE ATT&CK: T1132.001 – Data Encoding: Standard Encoding](https://attack.mitre.org/techniques/T1132/001/)
- [Lumma Stealer: Breaking down the delivery techniques and capabilities of a prolific infostealer](https://www.microsoft.com/en-us/security/blog/2025/05/21/lumma-stealer-breaking-down-the-delivery-techniques-and-capabilities-of-a-prolific-infostealer/)
- [Threat Actors Deploy LummaC2 Malware to Exfiltrate Sensitive Data from Organizations](https://www.cisa.gov/news-events/cybersecurity-advisories/aa25-141b)

---

## Version History

| Version | Date       | Impact            | Notes                                                                                      |
|---------|------------|-------------------|--------------------------------------------------------------------------------------------|
| 1.0     | 2025-06-04 | Initial Detection | Created hunt query to detect Lumma Stealer C2 traffic and fallback mechanisms              |
